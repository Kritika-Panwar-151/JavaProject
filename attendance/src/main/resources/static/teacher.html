<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Panel</title>

<style>
*{box-sizing:border-box;font-family:"Segoe UI",Arial}
:root{ --main-width:420px; }

body{
    height:100vh;margin:0;
    background:linear-gradient(135deg,#FAFAFA,#FCE4EC);
    display:flex;justify-content:center;align-items:center;
}
.card{
    width:480px;background:#fff;padding:40px;border-radius:16px;
    box-shadow:0 15px 40px rgba(0,0,0,.12);
    display:flex;flex-direction:column;align-items:center;
}
h2{margin-bottom:16px}

.form{
    width:100%;
    max-width:var(--main-width);
}
label{font-size:13px;margin-bottom:6px;display:block}
input{
    width:100%;
    padding:12px 14px;
    border-radius:10px;
    border:1px solid #BDBDBD;
    margin-bottom:16px;
}

button{
    border:none;border-radius:12px;
    background:#C2185B;color:#fff;
    font-size:15px;cursor:pointer;
}
.btn-wide{
    width:100%;
    max-width:var(--main-width);
    padding:14px;
    margin-bottom:10px;
}
.copy-btn{
    padding:6px 14px;
    font-size:13px;
    border-radius:20px;
}

.actions{
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
}
.hidden{display:none}

.code-row{
    width:100%;
    max-width:var(--main-width);
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:14px;
}
.code-box{
    font-size:18px;
    font-weight:600;
    color:#2E7D32;
}

.timer{
    font-size:16px;
    font-weight:600;
    margin-bottom:8px;
}
#sessionStatus{
    margin-bottom:14px;
    font-weight:600;
}
</style>
</head>

<body>
<div class="card">

<!-- LOGIN -->
<div id="loginDiv">
    <h2>Teacher Login</h2>
    <div class="form">
        <label>Teacher ID</label>
        <input id="tid">
        <label>Password</label>
        <input type="password" id="pwd">
        <button class="btn-wide" onclick="doLogin()">Login</button>
        <div id="loginStatus"></div>
    </div>
</div>

<!-- GENERATE -->
<div id="generateDiv" class="hidden">
    <h2>Create Attendance Session</h2>
    <div class="form">
        <label>Section</label>
        <input id="section">
        <label>Subject Code</label>
        <input id="subject">
        <button class="btn-wide" onclick="generateSession()">Generate Class Code</button>
    </div>
</div>

<!-- SESSION -->
<div id="sessionDiv" class="hidden">
    <h2>Session Control</h2>

    <div class="code-row">
        <div class="code-box">
            Class Code: <span id="classCode"></span>
        </div>
        <button class="copy-btn" onclick="copyCode()">Copy</button>
    </div>

    <div class="timer">
        Session Time: <span id="timer">00:00</span>
    </div>

    <div id="sessionStatus"></div>

    <div class="actions">
        <button id="startBtn" class="btn-wide" onclick="startSession()">Start Session</button>
        <button class="btn-wide" onclick="pauseSession()">Pause Session</button>
        <button class="btn-wide" onclick="resumeSession()">Resume Session</button>
        <button class="btn-wide" onclick="endSession()">End Session</button>
    </div>
</div>

<script>
/* DOM */
const loginDiv = document.getElementById("loginDiv");
const generateDiv = document.getElementById("generateDiv");
const sessionDiv = document.getElementById("sessionDiv");
const sessionStatus = document.getElementById("sessionStatus");
const startBtn = document.getElementById("startBtn");

let currentClassCode = "";
let seconds = 0;
let timerInterval = null;

/* LOGIN */
function doLogin(){
    fetch("/api/teacher/login",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            teacherId: tid.value,
            password: pwd.value
        })
    })
    .then(r => r.json())
    .then(res => {
        if(res.status === "SUCCESS"){
            loginDiv.classList.add("hidden");
            generateDiv.classList.remove("hidden");
        } else {
            loginStatus.innerText = "Invalid credentials";
        }
    });
}

/* GENERATE */
function generateSession(){
    fetch("/api/teacher/generate",{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
            section: section.value,
            subjectCode: subject.value
        })
    })
    .then(r => r.json())
    .then(res => {
        currentClassCode = res.classCode;
        classCode.innerText = res.classCode;
        generateDiv.classList.add("hidden");
        sessionDiv.classList.remove("hidden");
    });
}

/* TIMER */
function tick(){
    seconds++;
    timer.innerText =
        String(Math.floor(seconds/60)).padStart(2,"0") + ":" +
        String(seconds%60).padStart(2,"0");
}
function startClock(){
    if(timerInterval) return;
    timerInterval = setInterval(tick,1000);
}
function pauseClock(){
    clearInterval(timerInterval);
    timerInterval = null;
}
function resetClock(){
    pauseClock();
    seconds = 0;
    timer.innerText = "00:00";
}

/* SESSION */
function startSession(){
    navigator.geolocation.getCurrentPosition(pos => {

        fetch(`/api/teacher/start/${currentClassCode}`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                latitude: pos.coords.latitude,
                longitude: pos.coords.longitude
            })
        })
        .then(() => {
            sessionStatus.innerText = "Session Active";
            sessionStatus.style.color = "#2E7D32";
            startBtn.disabled = true;
            resetClock();
            startClock();
        });

    }, () => {
        alert("Location permission required");
    });
}

function pauseSession(){
    fetch(`/api/teacher/pause/${currentClassCode}`,{method:"POST"});
    pauseClock();
    sessionStatus.innerText="Session Paused";
    sessionStatus.style.color="#F57C00";
}

function resumeSession(){
    fetch(`/api/teacher/resume/${currentClassCode}`,{method:"POST"});
    startClock();
    sessionStatus.innerText="Session Active";
    sessionStatus.style.color="#2E7D32";
}

function endSession(){
    fetch(`/api/teacher/end/${currentClassCode}`,{method:"POST"})
    .then(() => {
        window.location.href =
            `/api/teacher/attendance/download/${currentClassCode}`;
        resetClock();
        sessionStatus.innerText="Session Ended";
        sessionStatus.style.color="#D32F2F";
    });
}

/* EXTRA */
function copyCode(){
    navigator.clipboard.writeText(currentClassCode);
}
</script>

</div>
</body>
</html>
